# OCR Pipeline Configuration
# Configuration for Indian Identity Documents: Aadhaar, PAN, Vehicle RC

# Image Quality Gate Thresholds (Relaxed for real-world scans)
quality:
  min_resolution: 200  # Minimum DPI equivalent (lowered for phone scans)
  min_blur_score: 50.0  # Laplacian variance threshold (lowered)
  min_brightness: 20  # Minimum mean pixel intensity (lowered)
  max_brightness: 240  # Maximum mean pixel intensity (increased)
  min_contrast_ratio: 0.2  # Minimum contrast ratio (much lower for scanned docs)
  min_edge_density: 0.005  # Minimum edge density (lowered)
  max_glare_ratio: 0.05  # Maximum fraction of overexposed pixels (glare)
  glare_threshold: 253  # Pixel value threshold for glare detection
  
  # Quality score weights
  weights:
    blur: 0.30
    brightness: 0.20
    resolution: 0.20
    contrast: 0.20
    glare: 0.10

# Business Logic Checks
business_rules:
  enabled: true
  
  date_validation:
    reject_future_dates: true
    max_age_days: 365

# Preprocessing Configuration
preprocessing:
  enable_skew_correction: true
  max_skew_angle: 45  # degrees
  enable_perspective_correction: true
  enable_illumination_normalization: true
  enable_noise_removal: true
  
  # CLAHE parameters
  clahe_clip_limit: 2.0
  clahe_tile_grid_size: [8, 8]
  
  # Noise removal
  median_blur_ksize: 3
  bilateral_d: 9
  bilateral_sigma_color: 75
  bilateral_sigma_space: 75

# Document Segmentation Configuration
segmentation:
  enabled: true
  
  # Contour-based detection
  contour_detection:
    enabled: true
    min_area_ratio: 0.20  # Minimum 20% of image area
    max_area_ratio: 0.95  # Maximum 95% of image area
    min_aspect_ratio: 0.3  # Minimum width/height ratio
    max_aspect_ratio: 3.0  # Maximum width/height ratio
    approx_epsilon: 0.02  # Contour approximation accuracy
  
  # Text-density clustering
  text_clustering:
    enabled: true
    min_cluster_size: 5  # Minimum text boxes per cluster
    eps: 50  # DBSCAN epsilon (pixel distance)
    min_samples: 3  # DBSCAN min samples
  
  # Region filtering
  max_regions: 5  # Maximum regions to process
  min_region_confidence: 0.3  # Minimum confidence to consider
  
  # Spatial validation
  spatial_validation:
    enabled: true
    max_field_dispersion: 0.5  # Maximum normalized std dev of field positions
    require_single_schema: true  # Reject if multiple schemas detected

# OCR Engine Configuration
ocr:
  # PaddleOCR Configuration
  paddle_ocr:
    use_angle_cls: true
    lang: 'en'  # 'en', 'ch', 'french', 'german', 'korean', 'japan'
    use_gpu: false  # Set to true if GPU is available
    show_log: false
  
  min_word_confidence: 60  # PaddleOCR usually has higher confidence
  min_words_detected: 5
  stopwords: ['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for']
  
  # Confidence aggregation weights
  numeric_token_weight: 1.5
  alpha_token_weight: 1.0
  stopword_weight: 0.3

# Semantic Validation Rules for Indian Documents
semantic:
  aadhaar:
    required_fields: ['aadhaar_number', 'name', 'date_of_birth']
    optional_fields: ['vid', 'gender', 'pin_code', 'enrollment_id', 'address', 'issue_date']
    
    # Field patterns (regex)
    patterns:
      aadhaar_number: '\d{4}\s?\d{4}\s?\d{4}'  # 12 digits with optional spaces
      vid: '\d{4}\s?\d{4}\s?\d{4}'  # Virtual ID format
      name: '[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*'  # Capitalized name
      date_of_birth: '\d{1,2}[/-]\d{1,2}[/-]\d{2,4}'  # Date format
      pin_code: '\d{6}'  # 6-digit PIN code
      enrollment_id: '[0-9]{14}'  # 14-digit enrollment ID
  
  pan:
    required_fields: ['pan_number', 'name', 'date_of_birth']
    optional_fields: ['father_name', 'signature_present']
    
    # Field patterns
    patterns:
      pan_number: '[A-Z]{5}\d{4}[A-Z]'  # PAN format: ABCDE1234F
      name: '[A-Z][A-Z\s]+'  # Uppercase name
      date_of_birth: '\d{1,2}[/-]\d{1,2}[/-]\d{2,4}'  # Date format
      father_name: '[A-Z][A-Z\s]+'  # Uppercase father's name
  
  vehicle_rc:
    required_fields: ['registration_number', 'owner_name', 'engine_number', 'chassis_number']
    optional_fields: ['vehicle_make_model', 'registration_date', 'vehicle_class', 'fuel_type', 
                      'seating_capacity', 'wheelbase', 'unladen_weight', 'vehicle_color', 
                      'hypothecation', 'fitness_validity_date', 'insurance_validity_date', 
                      'manufacturing_date']
    
    # Field patterns
    patterns:
      registration_number: '[A-Z]{2}\d{2}[A-Z]{1,2}\d{4}'  # State code + district + series + number
      engine_number: '[A-Z0-9]{6,15}'  # Engine number format
      chassis_number: '[A-Z0-9]{10,20}'  # Chassis number format
      owner_name: '[A-Z][A-Z\s]+'  # Uppercase owner name
      registration_date: '\d{1,2}[/-]\d{1,2}[/-]\d{2,4}'  # Date format

# Layout Validation
layout:
  aadhaar:
    anchors:
      - keyword: 'aadhaar'
        region: 'top'
        tolerance: 0.3
      - keyword: 'uidai'
        region: 'top'
        tolerance: 0.3
      - keyword: 'government of india'
        region: 'top'
        tolerance: 0.3
      - keyword: 'date of birth'
        region: 'center'
        tolerance: 0.4
      - keyword: 'आधार'
        region: 'top'
        tolerance: 0.3
    
    min_anchors_required: 2
  
  pan:
    anchors:
      - keyword: 'income tax'
        region: 'top'
        tolerance: 0.3
      - keyword: 'permanent account number'
        region: 'top'
        tolerance: 0.3
      - keyword: 'pan'
        region: 'top'
        tolerance: 0.3
      - keyword: 'government of india'
        region: 'top'
        tolerance: 0.3
      - keyword: 'father'
        region: 'center'
        tolerance: 0.4
    
    min_anchors_required: 2
  
  vehicle_rc:
    anchors:
      - keyword: 'registration certificate'
        region: 'top'
        tolerance: 0.3
      - keyword: 'registration number'
        region: 'top'
        tolerance: 0.3
      - keyword: 'engine no'
        region: 'center'
        tolerance: 0.4
      - keyword: 'chassis no'
        region: 'center'
        tolerance: 0.4
      - keyword: 'owner'
        region: 'top'
        tolerance: 0.3
    
    min_anchors_required: 2

# Anchor Keywords (Fuzzy Matching)
anchors:
  aadhaar:
    required: ['aadhaar', 'uidai', 'government of india', 'date of birth', 'आधार']
    optional: ['name', 'address', 'gender', 'pin', 'enrollment', 'vid']
    threshold: 80  # Levenshtein similarity threshold (0-100)
  
  pan:
    required: ['income tax', 'permanent account number', 'pan', 'government of india']
    optional: ['father', 'fathers name', 'signature', 'date of birth', 'dob']
    threshold: 80
  
  vehicle_rc:
    required: ['registration certificate', 'registration number', 'engine', 'chassis', 'owner']
    optional: ['vehicle', 'make', 'model', 'fuel', 'color', 'fitness', 'insurance']
    threshold: 80

# Token Distribution Profiles
distribution:
  aadhaar:
    min_numeric_ratio: 0.15  # Aadhaar has many digits
    max_special_char_ratio: 0.10
    avg_word_length_range: [3, 15]
  
  pan:
    min_numeric_ratio: 0.10  # PAN has alphanumeric mix
    max_special_char_ratio: 0.05
    avg_word_length_range: [3, 12]
  
  vehicle_rc:
    min_numeric_ratio: 0.20  # RC has many numbers (registration, engine, chassis)
    max_special_char_ratio: 0.15
    avg_word_length_range: [2, 15]

# Statistical Consistency Checks
consistency:
  aadhaar:
    enable_date_validation: true
    require_dob_in_past: true
    min_age: 0
    max_age: 150
  
  pan:
    enable_date_validation: true
    require_dob_in_past: true
    min_age: 0
    max_age: 150
  
  vehicle_rc:
    enable_date_validation: true
    require_registration_after_manufacturing: true
    require_fitness_after_registration: true
    require_insurance_after_registration: true

# Multi-Stage Scoring Weights
scoring:
  weights:
    image_quality: 0.10
    ocr_confidence: 0.15
    regex_match: 0.10
    fuzzy_match: 0.10
    layout_validity: 0.10
    kv_match: 0.10
    consistency: 0.10
    schema_completeness: 0.15
    distribution: 0.05
    spatial_compactness: 0.05  # Prevent cross-region field mixing
  
  # Field-level importance weights
  field_weights:
    aadhaar:
      aadhaar_number: 0.40  # Most critical
      name: 0.30
      date_of_birth: 0.30
    
    pan:
      pan_number: 0.50  # Most critical
      name: 0.25
      date_of_birth: 0.25
    
    vehicle_rc:
      registration_number: 0.40  # Most critical
      owner_name: 0.20
      engine_number: 0.20
      chassis_number: 0.20

# Decision Thresholds
decision:
  accept_threshold: 0.85
  review_threshold: 0.60
  reject_threshold: 0.60
  
  # Hard rejection rules
  hard_reject:
    no_text_detected: true
    quality_gate_failed: true
    mandatory_field_missing: true
    excessive_non_alphanumeric: 0.85
    multiple_documents_detected: true  # Reject if multiple high-confidence regions
    conflicting_schemas: true  # Reject if conflicting document schemas detected

# Batch Processing
batch:
  max_workers: 4  # Parallel processing workers
  chunk_size: 10  # Documents per batch
  enable_async: true

# Logging
logging:
  level: 'INFO'  # DEBUG, INFO, WARNING, ERROR
  format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  file: 'ocr_pipeline.log'
  max_bytes: 10485760  # 10MB
  backup_count: 5
