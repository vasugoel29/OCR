# OCR Pipeline Configuration

# Image Quality Gate Thresholds (Relaxed for real-world scans)
quality:
  min_resolution: 200  # Minimum DPI equivalent (lowered for phone scans)
  min_blur_score: 50.0  # Laplacian variance threshold (lowered)
  min_brightness: 20  # Minimum mean pixel intensity (lowered)
  max_brightness: 240  # Maximum mean pixel intensity (increased)
  min_contrast_ratio: 0.2  # Minimum contrast ratio (much lower for scanned docs)
  min_edge_density: 0.005  # Minimum edge density (lowered)
  max_glare_ratio: 0.05  # Maximum fraction of overexposed pixels (glare)
  glare_threshold: 253  # Pixel value threshold for glare detection
  
  # Quality score weights
  weights:
    blur: 0.30
    brightness: 0.20
    resolution: 0.20
    contrast: 0.20
    glare: 0.10

# Business Logic Checks
business_rules:
  enabled: true
  
  date_validation:
    reject_future_dates: true
    max_age_days: 365
    
  amount_validation:
    min_amount: 0.01
    max_amount: 1000000.0

# Preprocessing Configuration
preprocessing:
  enable_skew_correction: true
  max_skew_angle: 45  # degrees
  enable_perspective_correction: true
  enable_illumination_normalization: true
  enable_noise_removal: true
  
  # CLAHE parameters
  clahe_clip_limit: 2.0
  clahe_tile_grid_size: [8, 8]
  
  # Noise removal
  median_blur_ksize: 3
  bilateral_d: 9
  bilateral_sigma_color: 75
  bilateral_sigma_space: 75

# Document Segmentation Configuration
segmentation:
  enabled: true
  
  # Contour-based detection
  contour_detection:
    enabled: true
    min_area_ratio: 0.20  # Minimum 20% of image area
    max_area_ratio: 0.95  # Maximum 95% of image area
    min_aspect_ratio: 0.3  # Minimum width/height ratio
    max_aspect_ratio: 3.0  # Maximum width/height ratio
    approx_epsilon: 0.02  # Contour approximation accuracy
  
  # Text-density clustering
  text_clustering:
    enabled: true
    min_cluster_size: 5  # Minimum text boxes per cluster
    eps: 50  # DBSCAN epsilon (pixel distance)
    min_samples: 3  # DBSCAN min samples
  
  # Region filtering
  max_regions: 5  # Maximum regions to process
  min_region_confidence: 0.3  # Minimum confidence to consider
  
  # Spatial validation
  spatial_validation:
    enabled: true
    max_field_dispersion: 0.5  # Maximum normalized std dev of field positions
    require_single_schema: true  # Reject if multiple schemas detected


# OCR Engine Configuration
ocr:
  # PaddleOCR Configuration
  paddle_ocr:
    use_angle_cls: true
    lang: 'en'  # 'en', 'ch', 'french', 'german', 'korean', 'japan'
    use_gpu: false  # Set to true if GPU is available
    show_log: false
  
  min_word_confidence: 60  # PaddleOCR usually has higher confidence
  min_words_detected: 5
  stopwords: ['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for']
  
  # Confidence aggregation weights
  numeric_token_weight: 1.5
  alpha_token_weight: 1.0
  stopword_weight: 0.3

# Semantic Validation Rules
semantic:
  invoice:
    required_fields: ['invoice_number', 'date', 'total_amount']
    optional_fields: ['vendor_name', 'subtotal', 'tax', 'due_date']
    
    # Field patterns (regex)
    patterns:
      invoice_number: '[A-Z0-9-]{6,20}'
      amount: '\d+\.?\d{0,2}'
      date: '\d{1,2}[/-]\d{1,2}[/-]\d{2,4}'
    
    # Validation rules
    min_amount: 0.01
    max_amount: 1000000.0
    
  id_document:
    required_fields: ['id_number', 'name', 'date_of_birth']
    optional_fields: ['expiry_date', 'issue_date', 'address']
    
    # Field patterns
    patterns:
      id_number: '[A-Z0-9]{8,15}'
      name: '[A-Z][a-z]+(?: [A-Z][a-z]+)+'
      date: '\d{1,2}[/-]\d{1,2}[/-]\d{2,4}'

# Layout Validation
layout:
  invoice:
    anchors:
      - keyword: 'invoice'
        region: 'top'  # top, bottom, left, right, center
        tolerance: 0.3  # 30% of image dimension
      - keyword: 'total'
        region: 'bottom'
        tolerance: 0.3
      - keyword: 'date'
        region: 'top'
        tolerance: 0.3
    
    min_anchors_required: 2
    
  id_document:
    anchors:
      - keyword: 'name'
        region: 'top'
        tolerance: 0.3
      - keyword: 'date of birth'
        region: 'center'
        tolerance: 0.4
      - keyword: 'id'
        region: 'top'
        tolerance: 0.3
    
    min_anchors_required: 2
    photo_region: 'left'  # Expected photo location

# Anchor Keywords (Fuzzy Matching)
anchors:
  invoice:
    required: ['invoice', 'total', 'date', 'amount']
    optional: ['tax', 'subtotal', 'vendor', 'gst', 'bill to']
    threshold: 80  # Levenshtein similarity threshold (0-100)
    
  id_document:
    required: ['name', 'dob', 'id', 'date of birth']
    optional: ['address', 'gender', 'issue date', 'expiry']
    threshold: 80

# Token Distribution Profiles
distribution:
  invoice:
    min_numeric_ratio: 0.10
    max_special_char_ratio: 0.20
    avg_word_length_range: [2, 10]
    
  id_document:
    min_numeric_ratio: 0.05
    max_special_char_ratio: 0.15
    avg_word_length_range: [3, 12]

# Statistical Consistency Checks
consistency:
  invoice:
    enable_arithmetic_check: true
    arithmetic_tolerance: 0.02  # 2% tolerance for rounding
    enable_date_validation: true
    max_future_days: 30  # Allow invoices dated up to 30 days in future
    
  id_document:
    enable_date_validation: true
    require_expiry_after_issue: true
    min_age: 0  # Minimum age for ID holder
    max_age: 150

# Multi-Stage Scoring Weights
scoring:
  weights:
    image_quality: 0.10
    ocr_confidence: 0.15
    regex_match: 0.10
    fuzzy_match: 0.10
    layout_validity: 0.10
    kv_match: 0.10
    consistency: 0.10
    schema_completeness: 0.15
    distribution: 0.05
    spatial_compactness: 0.05  # NEW: Prevent cross-region field mixing

  
  # Field-level importance weights
  field_weights:
    invoice:
      invoice_number: 1.5
      total_amount: 2.0
      date: 1.5
      vendor_name: 1.0
      subtotal: 1.2
      tax: 1.2
    
    id_document:
      id_number: 2.0
      name: 1.8
      date_of_birth: 1.5
      expiry_date: 1.3

# Decision Thresholds
decision:
  accept_threshold: 0.85
  review_threshold: 0.60
  reject_threshold: 0.60
  
  # Hard rejection rules
  hard_reject:
    no_text_detected: true
    quality_gate_failed: true
    mandatory_field_missing: true
    excessive_non_alphanumeric: 0.85
    multiple_documents_detected: true  # NEW: Reject if multiple high-confidence regions
    conflicting_schemas: true  # NEW: Reject if conflicting document schemas detected


# Batch Processing
batch:
  max_workers: 4  # Parallel processing workers
  chunk_size: 10  # Documents per batch
  enable_async: true

# Logging
logging:
  level: 'INFO'  # DEBUG, INFO, WARNING, ERROR
  format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  file: 'ocr_pipeline.log'
  max_bytes: 10485760  # 10MB
  backup_count: 5
